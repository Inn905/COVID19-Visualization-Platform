<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>COVID19</title>
    <meta content='width=device-width, initial-scale=1.0, shrink-to-fit=no' name='viewport' />

    <!-- Fonts and icons -->
    <script src="js/webfont.min.js"></script>
    <script>
        WebFont.load({
            google: {"families":["Lato:300,400,700,900"]},
            custom: {"families":["Flaticon", "Font Awesome 5 Solid", "Font Awesome 5 Regular", "Font Awesome 5 Brands", "simple-line-icons"], urls: ['assets/css/fonts.min.css']},
            active: function() {
                sessionStorage.fonts = true;
            }
        });
    </script>

    <!-- CSS Files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.7.2/bluebird.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.4/fetch.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/fonts.css" />
    <link rel="stylesheet" type="text/css" href="css/styles.css?c" />


    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/atlantis.min.css">


</head>
<body>
<div class="wrapper sidebar_minimize">

    <div class="main-header">
        <!-- Logo Header -->
        <div class="logo-header" data-background-color="blue">

            <a href="index.html" class="logo">
                <img src="photos/logo.png" alt="navbar brand" class="navbar-brand">
            </a>
            <button class="navbar-toggler sidenav-toggler ml-auto" type="button" data-toggle="collapse" data-target="collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon">
                        <i class="icon-menu"></i>
                    </span>
            </button>
            <button class="topbar-toggler more"><i class="icon-options-vertical"></i></button>
            <div class="nav-toggle">
                <button class="btn btn-toggle toggle-sidebar">
                    <i class="icon-menu"></i>
                </button>
            </div>
        </div>
        <!-- End Logo Header -->

        <!-- Navbar Header -->
        <nav class="navbar navbar-header navbar-expand-lg" data-background-color="blue2">

            <div class="container-fluid">
                <div class="collapse" id="search-nav">


                </div>

            </div>
        </nav>
        <!-- End Navbar -->
    </div>

    <!-- Sidebar -->
    <div class="sidebar sidebar-style-2">
        <div class="sidebar-wrapper scrollbar scrollbar-inner">
            <div class="sidebar-content">
                <div class="user">
                    <div class="avatar-sm float-left mr-2">
                        <img src="photos/川菜.jpg" alt="..." class="avatar-img rounded-circle">
                    </div>
                    <div class="info">
                        <a data-toggle="collapse" aria-expanded="true">
                               <span>
									COVID2019
                            </span>
                            <span class="user-level" style="font-size:12px">
									抗击疫情人人有责
                            </span>
                        </a>
                        <div class="clearfix"></div>
                    </div>
                </div>
                <ul class="nav nav-primary">

                    <li class="nav-item active">
                        <a href="SpreadMap.html">
                            <i class="fas fa-map-marker-alt"></i>
                            <p>传播地图</p>
                        </a>
                    </li>

                    <li class="nav-item">
                        <a href="WordCloud.html">
                            <i class="fas fa-th-list"></i>
                            <p>关键词云</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="Curve.html" >
                            <i class="far fa-chart-bar"></i>
                            <p>数据查询</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="Map.html">
                            <i class="fas fa-layer-group"></i>
                            <p>态势地图</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="DataAnalysis.html">
                            <i class="fas fa-pen-square"></i>
                            <p>数据分析</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="SpatialAnalysis.html">
                            <i class="fas fa-table"></i>
                            <p>地图分析</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="index.html">
                            <i class="fas fa-home"></i>
                            <p>退出</p>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <!-- End Sidebar -->

    <div class="range-slider">
        <div id="spread"><img src="photos/play.svg" width="20" height="20" alt="Play" /><span class="spread-label">Play</span></div>
        <input id="slider" type="range" value="1000" min="0" max="1000" step="1" />
        <label>Week of <span id="date"></span></label>
    </div>

    <div id="legend" class="legend">
        <div class="legend-header">COVID-19 Cases</div>
        <ul>
            <li style="height:80px; z-index:1">
                <span class="circle" style="width:80px; height:80px; background-color: #EDF91C;"></span>
                <span class="label"><span class="label-val">10,000+</span></span>
            </li>
            <li style="height:66px; z-index:2">
                <span class="circle" style="width:66px; height:66px; background-color: #FB9533;"></span>
                <span class="label"><span class="label-val">2000</span></span>
            </li>
            <li style="height:54px; z-index:3">
                <span class="circle" style="width:54px; height:54px; background-color: #D34D60;"></span>
                <span class="label"><span class="label-val">500</span></span>
            </li>
            <li style="height:40px; z-index:4">
                <span class="circle" style="width:40px; height:40px; background-color: #921694;"></span>
                <span class="label"><span class="label-val">100</span></span>
            </li>
            <li style="height:20px; z-index:5">
                <span class="circle" style="width:20px; height:20px; background-color: #67009E;"></span>
                <span class="label"><span class="label-val">10</span></span>
            </li>
        </ul>
        <div class="new-cases">
            <span class="circle" style="background-color: cornflowerblue;"></span>
            <span class="label"><span class="label-val">New</span></span>
        </div>
    </div>

    <div id="map"></div>

</div>

<!--   Core JS Files   <script src="assets/js/bootstrap.min.js"></script>
<!-- jQuery Scrollbar  <script src="assets/js/jquery.scrollbar.min.js"></script>
<!-- Atlantis JS  <script src="assets/js/atlantis.min.js"></script>
-->

    <script type="text/javascript">
        // polyfill for array.includes()
        if (!Array.prototype.includes) {
            Array.prototype.includes = function (search, start) {
                'use strict';

                if (search instanceof RegExp) {
                    throw TypeError('first argument must not be a RegExp');
                }
                if (start === undefined) { start = 0; }
                return this.indexOf(search, start) !== -1;
            };
        }

        var dataUrl = 'data/dailies.geojson';
        var latestCountsUrl = 'data/latestCounts.json';

        var dates = [];
        var timeControl = document.getElementById("slider");
        var timeLabel = document.getElementById("date");

        var totalCases = document.getElementById("total-cases");
        var lastUpdatedDate = document.getElementById("last-updated-date");

        var modalWrapper = document.getElementById("modal-wrapper");
        var modal = document.getElementById("modal");
        var playButton = document.getElementById("spread");

        fetch(latestCountsUrl)
            .then(function(res) { return res.json(); })
            .then(function(res) {
                totalCases.innerText = res[0].caseCount
                lastUpdatedDate.innerText = res[0].date
            });

        var handleShowModal = function () {
            // switch elements to have 'display' value (block, flex) but keep hidden via opacity
            modalWrapper.classList.add('is-block');
            modal.classList.add('is-flex');
            setTimeout(function () {
                // for transition
                modalWrapper.classList.add('is-visible');
                modal.classList.add('is-visible');
            }, 40);
        }
        var handleHideModal = function () {
            modalWrapper.classList.remove('is-visible');
            modal.classList.remove('is-visible');
            setTimeout(function () {
                // for transition
                modalWrapper.classList.remove('is-block');
                modal.classList.add('is-flex');
            }, 400);
        }

        function initMap() {
            mapboxgl.accessToken = 'pk.eyJ1IjoiaGVhbHRobWFwIiwiYSI6ImNrOGl1NGNldTAyYXYzZnBqcnBmN3RjanAifQ.H377pe4LPPcymeZkUBiBtg';
            var map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/healthmap/ck7o47dgs1tmb1ilh5b1ro1vn',
                center: [10, 0],
                zoom: 1.5,
                // hash: true
            }).addControl(new mapboxgl.NavigationControl({"showZoom":false}), 'bottom-right');

            var animateMap = function() {
                var i = 0;
                var stepMap = setInterval(function() {
                    timeControl.value = i;
                    filterBy(dates[i]);
                    setTimeControlLabel(i);
                    i++;
                    if(i === dates.length) {
                        clearInterval(stepMap);
                    }
                }, 500);
            }

            function filterBy(isodate) {
                var filters = ['==', 'date', isodate];
                map.setFilter('daily', filters);
                map.setFilter('totals', filters);
            }

            function setTimeControlLabel(date) {
                timeLabel.innerText = dates[date];
            };

            function buildTimeControl() {
                timeControl.setAttribute("max", dates.length - 1)
                timeControl.setAttribute("value", dates.length - 1);
                setTimeControlLabel(dates.length - 1);
            };

            timeControl.addEventListener("input", function() {
                setTimeControlLabel(timeControl.value);
                filterBy(dates[timeControl.value]);
            });

            map.on('load', function () {
                map.addSource('counts', {
                    'type': 'geojson',
                    'data': {
                        'type': 'FeatureCollection',
                        'features': []
                    }
                });
                map.addLayer({
                    'id': 'totals',
                    'type': 'circle',
                    'source': 'counts',
                    'paint': {
                        'circle-radius': ['*', ['log10', ['sqrt', ['get', 'total']]], 20],
                        'circle-color': [
                            'step',
                            ['get', 'total'],
                            '#67009E',
                            10,
                            '#921694',
                            100,
                            '#D34d60',
                            500,
                            '#FB9533',
                            2000,
                            '#EDF91C',
                        ],
                        'circle-opacity': .6,
                    }
                });
                map.addLayer({
                    'id': 'daily',
                    'type': 'circle',
                    'source': 'counts',
                    'paint': {
                        'circle-radius': [ 'case', ['<', 0, ['number', ['get', 'new']]], ['*', ['log10', ['sqrt', ['get', 'new']]], 20], 0 ],
                        'circle-color': 'cornflowerblue',
                        'circle-opacity': 0.6,
                    }
                });

                // Create a popup, but don't add it to the map yet.
                var popup = new mapboxgl.Popup({
                    closeButton: false,
                    closeOnClick: false
                });

                // Create a popup, but don't add it to the map yet.
                var popup = new mapboxgl.Popup({
                    closeButton: false,
                    closeOnClick: false
                });

                map.on('mouseenter', 'totals', function (e) {
                    // Change the cursor style as a UI indicator.
                    map.getCanvas().style.cursor = 'pointer';

                    var coordinates = e.features[0].geometry.coordinates.slice();
                    var props = e.features[0].properties;
                    var city = props.city ? props.city + ', ' : '';
                    var province = props.province ? props.province + ', ' : '';
                    var country = props.country ? props.country : '';
                    var description =
                        '<h3 class="popup-header">' + city + province + country + '</h3>' +
                        '<div>' + '<strong>Number of Cases: </strong>' + props.total + '</div>';

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to.
                    while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                    }

                    // Populate the popup and set its coordinates
                    // based on the feature found.
                    popup
                        .setLngLat(coordinates)
                        .setHTML(description)
                        .addTo(map);
                });

                map.on('mouseleave', 'totals', function () {
                    map.getCanvas().style.cursor = '';
                    popup.remove();
                });

                // fetch(totalsUrl).then(res => res.json()).then(res => {
                //     map.getSource('cumulative').setData(res);
                // });

                fetch(dataUrl)
                    .then(function(res) { return res.json(); })
                    .then(function(res) {
                        var datesUnsorted = [];
                        res.features.forEach(function(feature) {
                            var date = feature.properties.date;
                            if (!datesUnsorted.includes(date)) {
                                datesUnsorted.push(date)
                            }
                        });
                        dates = datesUnsorted.sort();
                        buildTimeControl();
                        map.getSource('counts').setData(res);
                        filterBy(dates[dates.length - 1]);
                        playButton.addEventListener("click", function () {
                            animateMap();
                        });
                    });

            });
        }

    </script>

<script async defer src="js/mapbox-gl.js" onload="initMap()"></script>

<link href="js/mapbox-gl.css" rel="stylesheet" />

</body>
</html>